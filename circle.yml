machine:
  environment:
    NODE_ENV: test

checkout:
  post:
    - '[[ ! -e "$(git rev-parse --git-dir)/shallow" ]] || git fetch --unshallow'

dependencies:
  # Git requires user.email and user.name configured before git commit can be run.
  pre:
    - git config --global user.email "peter@2pventures.com"
    - git config --global user.name "CircleCI @ 2P Ventures"
  override:
    - npm prune
    - npm install jshint -g
    - npm install -g istanbul
    - npm install -g codeclimate-test-reporter
    - npm install request -g
    - bower prune
    - bower install
  cache_directories:
    - node_modules
    - bower_components
    - build

general:
  artifacts:
    - ./coverage

test:
  override:
    - grunt test
    - grunt build
    - istanbul cover karma/karma-unit.js
    - codeclimate-test-reporter < ./coverage/lcov.info
  post:
    - sed -i -e 's/\/node_modules//' .gitignore
    - sed -i -e 's/\/bower_components//' .gitignore
    - sed -i -e 's/\/bin//' .gitignore
    - sed -i -e 's/\/build//' .gitignore
    - git add -A
    - git commit -m "build"

deployment:
  # v4 branches
  try:
    branch: /try.*/
    commands:
      - git push -f git@heroku.com:${CIRCLE_PROJECT_REPONAME}-try.git ${CIRCLE_BRANCH}:master
  dev:
    branch: develop
    commands:
      - git push -f git@heroku.com:${CIRCLE_PROJECT_REPONAME}-dev.git ${CIRCLE_BRANCH}:master
  qa:
    branch: /release\/.+/
    commands:
      - git push -f git@heroku.com:${CIRCLE_PROJECT_REPONAME}-qa.git ${CIRCLE_BRANCH}:master
  client:
    branch: client
    commands:
      - git push -f git@heroku.com:${CIRCLE_PROJECT_REPONAME}-client.git ${CIRCLE_BRANCH}:master
  prod:
    branch: master
    commands:
      - git push -f git@heroku.com:mobius-prod.git ${CIRCLE_BRANCH}:master
  # v2 branches
  try-v2:
    branch: /try-v2.*/
    commands:
      - git push -f git@heroku.com:mobius-v2-try.git ${CIRCLE_BRANCH}:master
  dev-v2:
    branch: develop-v2
    commands:
      - git push -f git@heroku.com:mobius-v2-dev.git ${CIRCLE_BRANCH}:master
  qa-v2:
    branch: /release-v2\/.+/
    commands:
      - git push -f git@heroku.com:mobius-v2-qa.git ${CIRCLE_BRANCH}:master
  client-v2:
    branch: client-v2
    commands:
      - git push -f git@heroku.com:mobius-v2-stage.git ${CIRCLE_BRANCH}:master
  prod-v2:
    branch: master-v2
    commands:
      - git push -f git@heroku.com:mobius-v2-prod.git ${CIRCLE_BRANCH}:master
